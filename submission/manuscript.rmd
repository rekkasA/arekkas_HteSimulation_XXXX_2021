---
title: "Smooth risk-based predictive approaches to treatment effect heterogeneity: A simulation study"
output:
    bookdown::pdf_document2: default
    bookdown::word_document2:
        reference_docx: reference.docx
geometry: margin=1.0in
toc: false
font-size: 11pt
header-includes:
  - \renewcommand*\familydefault{\sfdefault}
  - \usepackage{setspace}
  - \usepackage{amsmath}
  - \doublespacing
  - \usepackage[left]{lineno}
editor_options: 
  chunk_output_type: console
bibliography: references.bib
csl: jce.csl
---


```{r, echo=FALSE, message=FALSE}
library(tidyverse)
library(knitr)
library(kableExtra)
library(SmoothHte)
library(rms)

d <- function(x, decimals = 2) {
  sprintf(paste0("%1.", decimals, "f"), x) 
}

knit_hooks$set(
  inline = function(x) {
    prettyNum(
      x,
      big.mark = ",",
      decimal.mark = ".",
      preserve.width = "individual"
    )
  }
)
```
\thispagestyle{empty}
\vspace{35mm}



Alexandros Rekkas${^1}$, Peter R. Rijnbeek${^1}$, ..., Ewout W. Steyerberg${^2}$, 
David van Klaveren${^3}$

\vspace{40mm}

$^1$ Department of Medical Informatics, Erasmus University Medical Center,
Rotterdam, Netherlands

$^2$ Department of Biomedical Data Sciences, Leiden University Medical Center,
Leiden, Netherlands

$^3$ Department of Public Health, Erasmus University Medical Center, Rotterdam,
Netherlands

\newpage
\newpage
\thispagestyle{empty}
# Abstract {-}
\singlespacing 
**Objective:** Simulation study to compare different risk-based approaches to
estimating individualized treatment effects within the RCT setting. **Study
Design and Setting:** Starting from a base case scenario that assumes a true
constant treatment effect, we considered a total of 66 scenarios for introducing
non-constant effects and evaluating methods under different sample sizes and
baseline risk prediction performance. We compared 7 methods for predicting
absolute benefit: A constant treatment effect model, a risk stratified approach,
a model including a linear interaction of the baseline risk linear predictor
with treatment, 3 restricted cubic spline smoothing models of increasing
flexibility (3, 4 and 5 knots) and an adaptive model selection method based on
Akaike's Information Criterion. We evaluated performance using root mean squared
error, discrimination for benefit and calibration for benefit (i.e., observed
vs. predicted risk difference in treated vs. untreated). **Results:** The model
including a linear interaction of the risk linear predictor with treatment had
adequate performance that was robust under the majority of the simulation
scenarios. Methods using restricted cubic spline smoothing required larger
sample sizes and higher prediction AUC to achieve adequate performance. The
adaptive approach's performance was comparable to the performance of the best
model in each scenario. **Conclusion:** In most cases using a model just
including a linear interaction of the risk linear predictor with treatment
adequately predicts absolute benefit.

\newpage 
\doublespacing 

\linenumbers


# Introduction

Within the setting of patient-centered outcomes research, predictive approaches
for assessing heterogeneity of treatment effects (HTE) aim at the development of
models predicting either individualized effects or which of two (or more)
treatments is better for an individual [@Varadhan2013]. In prior work, we
divided such methods in three broader categories based on the reference class
used for defining patient similarity when making individualized predictions or
recommendations [@Rekkas2020]. Risk-modeling approaches use prediction of
baseline risk as the reference; treatment effect modeling approaches also model
treatment-covariate interactions, in addition to risk factors; optimal treatment
regime approaches focus on developing treatment assignment rules and therefore
rely heavily on modeling treatment effect modifiers.

Risk-modeling approaches to predictive HTE analyses provide a viable option in
the absence of well-established treatment effect modifiers [@Kent2019;
@PathEnE]. In simulations, modeling of effect modifiers in the form of
treatment-covariate interactions often led to miscalibrated predictions of
benefit, while risk-based methods proved quite robust [@vanKlaveren2019]. Most
often, risk-modeling approaches are carried out in two steps: first a risk
prediction model is developed externally or internally on the entire RCT
population, "blinded" to treatment; then the RCT population is stratified using
this prediction model to evaluate risk-based treatment effect variation
[@Kent2010]. However, even though estimates at the risk subgroup level are
accurate, this does not apply on the individual level, especially for patients
with predicted risk at the boundaries of the risk intervals. Therefore, the
risk-stratified approach should be used for exploring and presenting an overview
of HTE, while inferences on the individual level should be made with caution.

We aimed to provide an overview of methods that can be used to move from a
risk-stratified approach to a continuous one using common smoothing techniques.
These methods extend the risk-based framework of predictive HTE analyses to
allow predictions on the individual level, within the RCT setting. We carried
out a simulation study to compare the performance of these methods under
different settings of increasing non-linearity of treatment effects. Finally, we
carried out an application on real data as a demonstration of the considered
techniques.

# Methods

## Simulation scenarios

In the simulated datasets of the base-case scenario treatment was allocated at
random using a 50/50 split. For each patient we simulated $8$ baseline
covariates, where $x_1,\dots,x_4\sim N(0, 1)$ and $x_5,\dots,x_8\sim B(1, 0.2)$.
Outcomes for patients in the control arm were generated from a logistic
regression model including all baseline covariates. Coefficient values were
such, so that the prediction model had an AUC of $0.75$ and an event rate of
$20\%$ in the control arm was achieved. Outcomes in the treatment arm were
created using the same logistic regression model, including a constant treatment
effect odds ratio (OR) of $0.8$. The generated samples of the base-case scenario
were of size $n=4,250$ ($80\%$ power for the detection of an unadjusted OR of
$0.8$).

We evaluated the effect of sample size considering additional scenarios with
sample sizes of $1,064$ and $17,000$. We also evaluated the effect of prediction
performance, adjusting the baseline covariate coefficients, so that AUC values
of $0.65$ and $0.80$ were achieved when validating in a simulated dataset of
$500,000$ patients.

A true logistic regression model with a constant treatment effect (constant OR)
implies that outcome risk in the treatment arm is a straight line parallel to
the first diagonal on the *log-odds* scale, with distance equal to $\log(\text{OR})$. 
We assessed the effect of stronger and absent relative treatment effects
($\text{OR}=0.5$ or $\text{OR}=1$). We also relaxed the assumption that the
line should be parallel to the diagonal, considering moderate and stronger
linear deviations. Finally, we dropped the assumption of linearity allowing for
quadratic deviations.

We also considered scenarios with treatment-covariate interactions. These
scenarios include 4 weak interactions
($\text{OR}_{t_x=1} / \text{OR}_{t_x=0}=0.82$), 
4 strong interactions 
($\text{OR}_{t_x=1} / \text{OR}_{t_x=0}=0.61$), 
and 2 weak and 2 strong interactions. Combining all these different settings
resulted in a simulation study of $66$ scenarios. The exact settings for each
scenario are available in the supplementary material.

## Individualized risk-based benefit predictions

All methods assume that a risk prediction model is available and can be used to
assign individualized predictions. For the simulations we developed the
prediction models internally and blinded to treatment using logistic regression
including main effects for all baseline covariates and treatment. Predictions on
individuals were made setting treatment to $0$. 

The **stratified HTE method** was suggested as an alternative to traditional
subgroup analyses. Patients are stratified into equally-sized risk strata---in
this case based on risk quartiles. Absolute effects are estimated using the
differences in event rates between treatments within risk quarters. We
considered this approach as a reference, expecting it to perform worse than the
other candidates, as its objective is not individual benefit prediction.

We also considered a set of **linear methods**. We fit separate models within
treatment arms using only the treatment indicator and the linear predictor of
the internal risk prediction model. In the simpler case, we assume a constant
relative treatment effect (OR). Absolute benefit is then estimated from
$\text{expit}(lp +\log(\text{OR}))$, 
where $\text{expit}(x)=\frac{e^x}{1+e^x}$
and *lp* is the linear predictor of the prediction model. A different approach
fits a logistic regression using treatment, risk linear predictor and their
interaction within each treatment arm. In this case, absolute benefit is
estimated from
$\text{expit}(\beta_0+\beta_{lp}lp) - \text{expit}(\beta_0+\beta_{t_x}+(\beta_{lp}+\beta_*)lp)$.
We will refer to this method as the linear interaction approach.


Finally, we used restricted cubic splines (RCS) to relax the linearity assumption on
the effect of the linear predictor [@Harrell1988]. We compared the results
for 3, 4 and 5 knots when fitting the splines to introduce increasing
flexibility to the methods considered.

## Evaluation metrics


# Results

## Simulations


The model including a constant relative treatment effect had the lowest median
RMSE in scenarios where the base case of true constant relative treatment effect
(OR = 0.8, N = 4250 and AUC = 0.75) or moderate relative deviations were
considered (Figure \@ref(fig:rmsebase); Panel A). However, when we considered
strong linear and quadratic deviations from the base case the linear interaction
model performed best (Figure \@ref(fig:rmsebase); Panels B and C). Only in the
case of strong quadratic deviations models including RCS smoothing (3 knots)
performed equally well to the linear interaction method. Increasing the number
of knots in RCS smoothing resulted in higher error rates across all scenarios.
The performance of the adaptive approach was quite comparable with the best
performing model in all scenarios.

```{r rmsebase, echo=FALSE, fig.cap="RMSE base case", fig.show="hold", out.width = '100%'}
knitr::include_graphics(here::here("figures/rmse_base.png"))
```

When we increased the sample size (N = 17000), in all scenarios the model more
in agreement with the underlying settings had the lowest error rates. Under the
base case of constant relative treatment effects (OR = 0.8), the model including
a constant relative treatment effect had the lowest RMSE (Figure
\@ref(fig:rmsesamplesize); Panel A). When introducing moderate and strong linear
deviations the linear interaction model performed best (Figure
\@ref(fig:rmsesamplesize); Panels B and C). In the case of true strong quadratic
deviations from the base case of constant relative effects, the more flexible
RCS smoothing models (3 knots) had the lowest RMSE. Again, the increased
flexibility of RCS smoothing with higher number of knots resulted in overfitting
and worse performance (Figure \@ref(fig:rmsesamplesize); Panel D).

```{r rmsesamplesize, echo=FALSE, fig.cap="Sample size 17000", fig.show="hold", out.width = '100%'}
knitr::include_graphics(here::here("figures/rmse_sample_size.png"))
```

When we increased the true prediction AUC to 0.85, models including RCS
smoothing had the lowest RMSE when strong quadratic deviations from the base
case of true constant relative treatment effects were assumed (Figure
\@ref(fig:rmseauc); Panel D). However, with milder deviations, the linear
interaction model had the lowest RMSE with the RCS smoothing methods (3 knots)
being a close second (Figure \@ref(fig:rmseauc); Panels B and C). Increasing the
number of knots of RCS smoothing resulted in increased RMSE, which was less
pronounced in the case of strong quadratic deviations.

```{r rmseauc, echo=FALSE, fig.cap="AUC 0.85", fig.show="hold", out.width = '100%'}
knitr::include_graphics(here::here("figures/rmse_auc.png"))
```


All candidate methods demonstrated comparable discrimination for benefit in all
scenarios where linear and quadratic deviations from the base case of constant
treatment effect were considered (Figure \@ref(fig:discrimination)). However,
models including a linear interaction with the risk linear predictor tended to
present much lower variability compared to all other model-based and smoothing
approaches. We also observed an increasing trend of discrimination for benefit
variability with increasing number of restricted cubic spline knots in all
scenarios. This is evidence that the increased flexibility of these methods
often led to overfitting.


```{r discrimination, echo=FALSE, fig.cap="Discrimination for benefit base case.", fig.show="hold", out.width = '100%'}
knitr::include_graphics(here::here("figures/discrimination_base.png"))
```

When focusing on calibration for benefit, the linear interaction model had the
lowest median ICI for benefit in the majority of the scenarios except for the
scenarios where moderate linear deviations from the base case were considered.
In that case constant treatment effect models demonstrated the best performance,
very comparable to the linear interaction model's performance, nonetheless
(Figure \@ref(fig:calibration); Panels A, B, and C).

```{r calibration, echo=FALSE, fig.cap="Calibration for benefit base case.", fig.show="hold", out.width = '100%'}
knitr::include_graphics(here::here("figures/calibration_base.png"))
```

## Real data
```{r, echo=FALSE, warning=FALSE, message=FALSE}
load(here::here("data/raw/gusto.rda"))
gusto <- gusto %>%
  tibble() %>%
  filter(!is.na(tpa))

treatmentArms <- gusto %>%
  group_by(tpa) %>%
  summarise(n = n())
```

We demonstrate the different methods for individualizing treatment benefits
using data from `r nrow(gusto)` patients with an acute myocardial infarction
(MI) included in the GUSTO-I trial.
`r treatmentArms %>% filter(tpa == 1) %>% select(n)` patients were randomized to
tissue plasminogen activator (tPA) treatment and
`r treatmentArms %>% filter(tpa == 0) %>% select(n)` were randomized to
streptokinase. The outcome of interest was 30-day mortality, recorded for all
patients.

In line with (Califf 1997; Steyerberg 2000), we fitted a logistic regression
model with 6 baseline covariates, i.e. age, Killip class, systolic blood
pressure, heart rate, an indicator of previous MI, and the location of MI, to
predict 30-day mortality risk. A constant effect of treatment was included in
the model. When deriving risk predictions for individuals we set the treatment
indicator to 0. More information on model development can be found in the
supplement.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
gusto <- gusto %>%
  tibble() %>%
  rename(
    "outcome" = "day30",
    "treatment" = "tpa"
  )

prediction <- lrm(
  outcome ~ treatment + age + Killip + pmin(sysbp, 120) + lsp(pulse, 50) + pmi + miloc,
  data = gusto,
  maxit = 99
)

riskLinearPredictor <- predict(
  prediction,
  newdata = gusto %>% mutate(treatment = 0) %>% data.frame()
)

gusto <- gusto %>%
  mutate(
    riskLinearPredictor = riskLinearPredictor
  )

constantModel <- fitModelBasedHte(
  data     = gusto, 
  settings = createModelBasedSettings(type = "treatment")
)

tmp <- gusto %>%
  mutate(
    predictedBenefit = predictBenefitModelBasedHte(
      p             = plogis(.$riskLinearPredictor), 
      modelBasedFit = constantModel
    )
  )

constantC   <- calculateCForBenefit(tmp)
constantIci <- calculateCalibrationForBenefit(tmp)

stratified <- fitStratifiedHte(
  data     = gusto,
  settings = createStratifiedSettings()
)

linearModel <- fitModelBasedHte(
  data     = gusto,
  settings = createModelBasedSettings()
)

tmp <- gusto %>%
  mutate(
    predictedBenefit = predictBenefitModelBasedHte(
      p             = plogis(.$riskLinearPredictor), 
      modelBasedFit = linearModel
    )
  )

linearC   <- calculateCForBenefit(tmp)
linearIci <- calculateCalibrationForBenefit(tmp)

rcs3Model <- fitRcsHte(
  data     = gusto,
  settings = createRcsSettings()
)

tmp <- gusto %>%
  mutate(
    predictedBenefit = predictSmoothBenefit(
      p          = plogis(riskLinearPredictor), 
      smoothFit  = rcs3Model
    )
  )

rcs3C   <- calculateCForBenefit(tmp)
rcs3Ici <- calculateCalibrationForBenefit(tmp)


rcs4Model <- fitRcsHte(
  data     = gusto,
  settings = createRcsSettings(nKnots = 4)
)

tmp <- gusto %>%
  mutate(
    predictedBenefit = predictSmoothBenefit(
      p          = plogis(riskLinearPredictor), 
      smoothFit  = rcs4Model
    )
  )

rcs4C   <- calculateCForBenefit(tmp)
rcs4Ici <- calculateCalibrationForBenefit(tmp)

rcs5Model <- fitRcsHte(
  data     = gusto,
  settings = createRcsSettings(nKnots = 5)
)

tmp <- gusto %>%
  mutate(
    predictedBenefit = predictSmoothBenefit(
      p          = plogis(.$riskLinearPredictor), 
      smoothFit  = rcs5Model
    )
  )

rcs5C   <- calculateCForBenefit(tmp)
rcs5Ici <- calculateCalibrationForBenefit(tmp)

gustoPerformance <- tibble(
  discrimination = c(
    constantC, linearC, rcs3C,
    rcs4C, rcs5C
  ),
  calibration = c(
    constantIci$ici, linearIci$ici, rcs3Ici$ici,
    rcs4Ici$ici, rcs5Ici$ici
  ),
  method = c(
    "constant treatment effect",
    "linear interaction",
    "RCS smoothing with 3 knots",
    "RCS smoothing with 4 knots",
    "RCS smoothing with 5 knots"
  )
)

cBenefit <- gustoPerformance %>% arrange(discrimination)

```

We used the risk linear predictor to fit the the proposed methods under study
for individualizing absolute benefit predictions. All methods had quite
comparable results, in the sense that we predicted increasing benefits for
patients with higher baseline risk predictions. In terms of c-for benefit,
validated internally, all models had quite comparable performance ranging from
0.519 (RCS smoothing with 3 knots) to 0.542 (RCS smoothing with 4 knots).
Similar conclusions could be drawn in terms of ICI-for-benefit which ranged
from 0.0039 (linear interaction approach) to 0.0053 (RCS smoothing with 4
knots).

The adaptive approach picked the
model with RCS smoothing with 4 knots, which had quite comparable performance to
the smooth fit with 5 knots. However, for lower baseline risk these 2 models
predicted implausible benefits and maybe should be avoided when applying such
models in practice. The linear interaction model and the model with RCS
smoothing (3 knots) made very similar predictions, while also followed quite
closely the evolution of the stratified estimates. In this case, we observed
that even using a simple model with a constant relative treatment effect can
result in very similar benefit predictions as other more complex approaches.

```{r gusto, echo=FALSE, fig.cap="Caption", fig.show="hold", out.width = '100%'}
knitr::include_graphics(here::here("figures/gusto.png"))
```


\newpage
# References
\nolinenumbers
\setlength{\parindent}{-0.25in}
\setlength{\leftskip}{0.25in}
\noindent
<div id="refs"></div>
\setlength{\parindent}{0in}
\setlength{\leftskip}{0in}
\noindent